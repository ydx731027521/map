<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
		<title>天地图影像切片加载</title>
		<style>
			html,
			body,
			#viewDiv {
				padding: 0;
				margin: 0;
				height: 100%;
				width: 100%;
			}

			#measurements {
				padding: 4px 8px;
				font-size: 16px;
				bottom: 15px;
				left: 50%;
				margin-right: -50%;
				transform: translate(-50%, -50%);
			}
		</style>

		<link rel="stylesheet" href="https://js.arcgis.com/4.15/esri/themes/light/main.css" />
		<script src="https://js.arcgis.com/4.15/dojo/dojo.js"></script>

		<script>
			require(["esri/widgets/Locate", "esri/Map", "esri/views/MapView", "esri/Basemap", "esri/layers/WebTileLayer",
				"esri/widgets/Search",
				"esri/widgets/Locate",
				"esri/widgets/Sketch",
				"esri/widgets/Track",
				"esri/Graphic",
				"esri/layers/GraphicsLayer",
				"esri/geometry/geometryEngine",
				"esri/Graphic",
				"esri/widgets/BasemapToggle",
				"esri/widgets/BasemapGallery",
				"esri/geometry/SpatialReference",
				"esri/geometry/Extent",
				"esri/layers/support/TileInfo",
			], function(Locate, Map, MapView, Basemap,
				WebTileLayer, Search, Locate,
				Sketch,
				Track,
				Graphic,
				GraphicsLayer,
				geometryEngine,
				Graphic, BasemapToggle, BasemapGallery, SpatialReference, Extent, TileInfo) {
				// var tiledLayer = new WebTileLayer({
				// 	urlTemplate: "http://{subDomain}.tianditu.gov.cn/DataServer?T=img_w&x={col}&y={row}&l={level}&tk=339f594ff7e58b6064efde6940047a28",
				// 	subDomains: ["t0", "t1", "t2", "t3", "t4", "t5", "t6", "t7"],
				// });
				// var tiledLayerAnno = new WebTileLayer({
				// 	urlTemplate: "http://{subDomain}.tianditu.gov.cn/DataServer?T=cia_w&x={col}&y={row}&l={level}&tk=339f594ff7e58b6064efde6940047a28",
				// 	subDomains: ["t0", "t1", "t2", "t3", "t4", "t5", "t6", "t7"],
				// });

				// var tiledLayer2 = new WebTileLayer({
				// 	urlTemplate: "http://{subDomain}.tianditu.gov.cn/DataServer?T=vec_w&x={col}&y={row}&l={level}&tk=339f594ff7e58b6064efde6940047a28",
				// 	subDomains: ["t0", "t1", "t2", "t3", "t4", "t5", "t6", "t7"],
				// });
				// var tiledLayerAnno2 = new WebTileLayer({
				// 	urlTemplate: "http://{subDomain}.tianditu.gov.cn/DataServer?T=cva_w&x={col}&y={row}&l={level}&tk=339f594ff7e58b6064efde6940047a28",
				// 	subDomains: ["t0", "t1", "t2", "t3", "t4", "t5", "t6", "t7"],
				// });
				// // 影像图
				// bm_img = new Basemap({
				// 	baseLayers: [tiledLayer, tiledLayerAnno],
				// 	thumbnailUrl: '../../static/img_c.png',
				// 	title: '影像地图',
				// 	id: '影像地图'
				// });
				// // 矢量图
				// bm_vec = new Basemap({
				// 	baseLayers: [tiledLayer2, tiledLayerAnno2],
				// 	thumbnailUrl: '../../static/vec_c.png',
				// 	title: '矢量地图',
				// 	id: '矢量地图'
				// });

				var wkid = 4326;

				var tdtConfig = {
					serverUrl: 'http://{subDomain}.tianditu.gov.cn/DataServer',
					tk: '5bcc356651959d00e04aba3c1063d66e',
					subDomains: ['t0', 't1', 't2', 't3', 't4', 't5', 't6', 't7'],
				}

				var titleInfo = {
					dpi: 90.71428571427429,
					format: "image/png",
					compressionQuality: 0,
					rows: 256,
					cols: 256,
					origin: {
						x: -180,
						y: 90
					},
					lods: [{
							level: 2,
							levelValue: 2,
							resolution: 0.3515625,
							scale: 147748796.52937502,
						},
						{
							level: 3,
							levelValue: 3,
							resolution: 0.17578125,
							scale: 73874398.264687508,
						},
						{
							level: 4,
							levelValue: 4,
							resolution: 0.087890625,
							scale: 36937199.132343754,
						},
						{
							level: 5,
							levelValue: 5,
							resolution: 0.0439453125,
							scale: 18468599.566171877,
						},
						{
							level: 6,
							levelValue: 6,
							resolution: 0.02197265625,
							scale: 9234299.7830859385,
						},
						{
							level: 7,
							levelValue: 7,
							resolution: 0.010986328125,
							scale: 4617149.8915429693,
						},
						{
							level: 8,
							levelValue: 8,
							resolution: 0.0054931640625,
							scale: 2308574.9457714846,
						},
						{
							level: 9,
							levelValue: 9,
							resolution: 0.00274658203125,
							scale: 1154287.4728857423,
						},
						{
							level: 10,
							levelValue: 10,
							resolution: 0.001373291015625,
							scale: 577143.73644287116,
						},
						{
							level: 11,
							levelValue: 11,
							resolution: 0.0006866455078125,
							scale: 288571.86822143558,
						},
						{
							level: 12,
							levelValue: 12,
							resolution: 0.00034332275390625,
							scale: 144285.93411071779,
						},
						{
							level: 13,
							levelValue: 13,
							resolution: 0.000171661376953125,
							scale: 72142.967055358895,
						},
						{
							level: 14,
							levelValue: 14,
							resolution: 8.58306884765625e-5,
							scale: 36071.483527679447,
						},
						{
							level: 15,
							levelValue: 15,
							resolution: 4.291534423828125e-5,
							scale: 18035.741763839724,
						},
						{
							level: 16,
							levelValue: 16,
							resolution: 2.1457672119140625e-5,
							scale: 9017.8708819198619,
						},
						{
							level: 17,
							levelValue: 17,
							resolution: 1.0728836059570313e-5,
							scale: 4508.9354409599309,
						},
						{
							level: 18,
							levelValue: 18,
							resolution: 5.3644180297851563e-6,
							scale: 2254.4677204799655,
						},
						{
							level: 19,
							levelValue: 19,
							resolution: 2.68220901489257815e-6,
							scale: 1127.23386023998275,
						},
						{
							level: 20,
							levelValue: 20,
							resolution: 1.341104507446289075e-6,
							scale: 563.616930119991375,
						},
					],
				}

				var extent = new Extent(
					116.17,
					39.83,
					116.61,
					39.98,
					new SpatialReference({
						wkid: 4326
					})
				);

				var spatialReference = new SpatialReference({
					wkid: wkid,
				});

				titleInfo.spatialReference = new SpatialReference({
					wkid: wkid,
				});
				
				var tileInfo = new TileInfo(titleInfo);
				var {
					serverUrl,
					subDomains,
					tk
				} = tdtConfig;

				var vecLayer = new WebTileLayer({
					urlTemplate: `${serverUrl}?T=vec_c&x={col}&y={row}&l={level}&tk=${tk}`,
					subDomains,
					tileInfo,
					spatialReference,
				});

				var imgLayer = new WebTileLayer({
					urlTemplate: `${serverUrl}?T=img_c&x={col}&y={row}&l={level}&tk=${tk}`,
					subDomains,
					tileInfo,
					spatialReference,
				});
				// 矢量标注
				var ciaLayer1 = new WebTileLayer({
					urlTemplate: `${serverUrl}?T=cva_c&x={col}&y={row}&l={level}&tk=${tk}`,
					subDomains,
					tileInfo,
					spatialReference,
				});
				// 影像标注
				var ciaLayer2 = new WebTileLayer({
					urlTemplate: `${serverUrl}?T=cia_c&x={col}&y={row}&l={level}&tk=${tk}`,
					subDomains,
					tileInfo,
					spatialReference,
				});

				var vectoBasemap = new Basemap({
					baseLayers: [vecLayer, ciaLayer1],
					title: 'vectoBasemap',
					id: 'vectoBasemap',
				});

				var imageBasemap = new Basemap({
					baseLayers: [imgLayer, ciaLayer2],
					title: 'imageBasemap',
					id: 'imageBasemap',
				});

				var map = new Map({
					basemap: imageBasemap, // 默认影像图
				});

				var view = new MapView({
					container: 'viewDiv',
					extent,
					map,
					// id: mapId,
					center: [116.423816, 39.923125],
					zoom: 12,
					ui: {
						components: [],
					},
					constraints: {
						rotationEnabled: false // 禁止旋转
					},
				});


				// var map = new Map({
				// 	// basemap: {
				// 	// 	baseLayers: [tiledLayer, tiledLayerAnno]
				// 	// }
				// 	basemap: bm_img
				// });

				// var view = new MapView({
				// 	container: "viewDiv",
				// 	map: map,
				// 	zoom: 10,
				// 	constraints: {
				// 		maxZoom: 18
				// 	},
				// 	center: [104.072619, 30.663776], // longitude, latitude
				// 	spatialReference: {
				// 		wkid: 4326
				// 	}
				// });
				//搜索地址栏
				var search = new Search({ //Add Search widget
					view: view
				});
				view.ui.add(search, "bottom-left");
				//图层
				// const basemapToggle = new BasemapToggle({
				// 	view: view,
				// 	nextBasemap: bm_vec,
				// });
				// view.ui.add(basemapToggle, "top-right");

				//去掉logo
				view.ui.remove('attribution')
				//移除放大缩小按钮
				view.ui.remove('zoom')
				// 添加草图小部件
				var graphicsLayer = new GraphicsLayer();
				map.add(graphicsLayer);
				var sketch = new Sketch({
					layer: graphicsLayer,
					view: view,
					availableCreateTools: ["polyline", "polygon"],
					creationMode: "update",
					updateOnGraphicClick: true,
					visibleElements: {
						createTools: {
							point: false,
							circle: false
						},
						selectionTools: {
							"lasso-selection": false,
							"rectangle-selection": false,
						},
						settingsMenu: false,
						undoRedoMenu: false
					}
				});
				view.ui.add(sketch, "top-right");

				const measurements = document.getElementById("measurements");
				view.ui.add(measurements, "manual");

				//创建测量默认图形
				// const polygon = {
				// 	type: "polygon",
				// 	spatialReference: {
				// 		wkid: 3857,
				// 	},
				// 	rings: [
				// 		[
				// 			[-4508069.082189632, 3599936.936171892],
				// 			[-4508069.082189632, 5478453.343307884],
				// 			[-2629552.6750536393, 5478453.343307884],
				// 			[-2629552.6750536393, 3599936.936171892],
				// 			[-4508069.082189632, 3599936.936171892],
				// 		],
				// 	],
				// };

				// const simplePolygonSymbol = {
				// 	type: "simple-fill",
				// 	outline: {
				// 		color: [200, 0, 0],
				// 		width: 2,
				// 	},
				// };

				// const polygonGraphic = new Graphic({
				// 	geometry: polygon,
				// 	symbol: simplePolygonSymbol
				// });

				// graphicsLayer.add(polygonGraphic);

				var locate = new Locate({
					view: view,
					graphic: new Graphic({
						symbol: {
							type: "simple-marker",
							size: "12px",
							color: "green",
							outline: {
								color: "#efefef",
								width: "1.5px"
							}
						}
					}),
					useHeadingEnabled: false
				});
				view.ui.add(locate, "bottom-right");
				
				// let locateWidget = new Locate({
				//   viewModel: { // autocasts as new LocateViewModel()
				//     view: view
				//   },
				//   container: "viewDiv"
				// });
				
				// locateWidget.locate().then(function(res){
				//   // Fires after the user's location has been found
				//   // console.log(res)
				// });

				// var basemapGallery = new BasemapGallery({
				// 	view: view,
				// 	source: basemaps
				// });
				// view.ui.add(basemapGallery, {
				// 	position: "top-right"
				// });
				// view.when(() => {
				// 	sketch.update(polygonGraphic);
				// 	getArea(polygonGraphic.geometry);
				// });
				sketch.on("update", (e) => {
					const geometry = e.graphics[0].geometry;
					if (e.state === "start") {
						switchType(geometry);
					}

					if (e.state === "complete") {
						graphicsLayer.remove(graphicsLayer.graphics.getItemAt(0));
						measurements.innerHTML = null;
					}

					if (
						e.toolEventInfo &&
						(e.toolEventInfo.type === "scale-stop" ||
							e.toolEventInfo.type === "reshape-stop" ||
							e.toolEventInfo.type === "move-stop")
					) {
						switchType(geometry);
					}

				});

				function getArea(polygon) {
					const geodesicArea = geometryEngine.geodesicArea(polygon, "square-kilometers");
					const planarArea = geometryEngine.planarArea(polygon, "square-kilometers");
					measurements.innerHTML =
						"<b>Geodesic area</b>:  " + geodesicArea.toFixed(2) + " km\xB2" + " |   <b>Planar area</b>: " +
						planarArea.toFixed(2) + "  km\xB2";
				}

				function getLength(line) {
					const geodesicLength = geometryEngine.geodesicLength(line, "kilometers");
					const planarLength = geometryEngine.planarLength(line, "kilometers");
					measurements.innerHTML =
						"<b>Geodesic length</b>:  " + geodesicLength.toFixed(2) + " km" + " |   <b>Planar length</b>: " +
						planarLength.toFixed(2) + "  km";
				}

				function switchType(geom) {
					switch (geom.type) {
						case "polygon":
							getArea(geom);
							break;
						case "polyline":
							getLength(geom);
							break;
						default:
							console.log("No value found");
					}
				}
				
				function showPosition(position){
					var lat = position.coords.latitude;
					var lag= position.coords.longitude;
					
					view.goTo({
						center: [lat, lag]
					})
				}
				
				function getLocation() {
					if(navigator.geolocation){
							navigator.geolocation.getCurrentPosition(showPosition)
					}
				}
				
				setTimeout(() => {
					getLocation()
				}, 5000)

			});
		</script>
	</head>

	<body>
		<div id="viewDiv">
			<div id="measurements" class="esri-widget">
			</div>
		</div>
	</body>

</html>
